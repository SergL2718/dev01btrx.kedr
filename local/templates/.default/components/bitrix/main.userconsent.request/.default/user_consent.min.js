(function(){function a(b){this.caller=b.caller;this.formNode=b.formNode;this.controlNode=b.controlNode;this.inputNode=b.inputNode;this.config=b.config}a.prototype={};BX.UserConsent={msg:{title:"MAIN_USER_CONSENT_REQUEST_TITLE",btnAccept:"MAIN_USER_CONSENT_REQUEST_BTN_ACCEPT",btnReject:"MAIN_USER_CONSENT_REQUEST_BTN_REJECT",loading:"MAIN_USER_CONSENT_REQUEST_LOADING",errTextLoad:"MAIN_USER_CONSENT_REQUEST_ERR_TEXT_LOAD"},events:{save:"main-user-consent-request-save",refused:"main-user-consent-request-refused",accepted:"main-user-consent-request-accepted"},current:null,autoSave:false,isFormSubmitted:false,isConsentSaved:false,attributeControl:"data-bx-user-consent",load:function(b){var c=this.find(b)[0];if(!c){return null}this.bind(c);return c},loadAll:function(c,b){this.find(c,b).forEach(this.bind,this)},loadFromForms:function(){var b=document.getElementsByTagName("FORM");b=BX.convert.nodeListToArray(b);b.forEach(this.loadAll,this)},find:function(c){if(!c){return[]}var b=c.querySelectorAll("["+this.attributeControl+"]");b=BX.convert.nodeListToArray(b);return b.map(this.createItem.bind(this,c)).filter(function(d){return !!d})},bind:function(b){if(b.config.submitEventName){BX.addCustomEvent(b.config.submitEventName,this.onSubmit.bind(this,b))}else{if(b.formNode){BX.bind(b.formNode,"submit",this.onSubmit.bind(this,b))}}BX.bind(b.controlNode,"click",this.onClick.bind(this,b))},createItem:function(d,b){var g=b.querySelector('input[type="checkbox"]');if(!g){return}try{var c=JSON.parse(b.getAttribute(this.attributeControl));var f={formNode:null,controlNode:b,inputNode:g,config:c};if(d.tagName=="FORM"){f.formNode=d}else{f.formNode=BX.findParent(g,{tagName:"FORM"})}f.caller=this;return new a(f)}catch(h){return null}},onClick:function(b,c){this.requestForItem(b);c.preventDefault()},onSubmit:function(b,c){this.isFormSubmitted=true;if(this.check(b)){return true}else{if(c){c.preventDefault()}return false}},check:function(b){if(b.inputNode.checked){this.saveConsent(b);return true}this.requestForItem(b);return false},requestForItem:function(b){this.setCurrent(b);this.requestConsent(b.config.id,{sec:b.config.sec,replace:b.config.replace},this.onAccepted,this.onRefused)},setCurrent:function(b){this.current=b;this.autoSave=b.config.autoSave;this.actionRequestUrl=b.config.actionUrl},onAccepted:function(){if(!this.current){return}var b=this.current;this.saveConsent(this.current,function(){BX.onCustomEvent(b,this.events.accepted,[]);BX.onCustomEvent(this,this.events.accepted,[b]);this.isConsentSaved=true;if(this.isFormSubmitted&&b.formNode&&!b.config.submitEventName){BX.submit(b.formNode)}});this.current.inputNode.checked=true;this.current=null},onRefused:function(){BX.onCustomEvent(this.current,this.events.refused,[]);BX.onCustomEvent(this,this.events.refused,[this.current]);this.current.inputNode.checked=false;this.current=null;this.isFormSubmitted=false},initPopup:function(){if(this.popup){return}this.popup={}},popup:{isInit:false,caller:null,nodes:{container:null,shadow:null,head:null,loader:null,content:null,textarea:null,buttonAccept:null,buttonReject:null},onAccept:function(){this.hide();BX.onCustomEvent(this,"accept",[])},onReject:function(){this.hide();BX.onCustomEvent(this,"reject",[])},init:function(){if(this.isInit){return true}var c=document.querySelector("script[data-bx-template]");if(!c){return false}var b=document.createElement("DIV");b.innerHTML=c.innerHTML;b=b.children[0];if(!b){return false}document.body.insertBefore(b,document.body.children[0]);this.isInit=true;this.nodes.container=b;this.nodes.shadow=this.nodes.container.querySelector("[data-bx-shadow]");this.nodes.head=this.nodes.container.querySelector("[data-bx-head]");this.nodes.loader=this.nodes.container.querySelector("[data-bx-loader]");this.nodes.content=this.nodes.container.querySelector("[data-bx-content]");this.nodes.textarea=this.nodes.container.querySelector("[data-bx-textarea]");this.nodes.buttonAccept=this.nodes.container.querySelector("[data-bx-btn-accept]");this.nodes.buttonReject=this.nodes.container.querySelector("[data-bx-btn-reject]");this.nodes.buttonAccept.textContent=BX.message(this.caller.msg.btnAccept);this.nodes.buttonReject.textContent=BX.message(this.caller.msg.btnReject);BX.bind(this.nodes.buttonAccept,"click",this.onAccept.bind(this));BX.bind(this.nodes.buttonReject,"click",this.onReject.bind(this));return true},setTitle:function(b){if(!this.nodes.head){return}this.nodes.head.textContent=b},setContent:function(b){if(!this.nodes.textarea){return}this.nodes.textarea.textContent=b},show:function(b){if(typeof b=="boolean"){this.nodes.loader.style.display=!b?"":"none";this.nodes.content.style.display=b?"":"none"}this.nodes.container.style.display=""},hide:function(){this.nodes.container.style.display="none"}},cache:{list:[],stringifyKey:function(b){return BX.type.isString(b)?b:JSON.stringify({key:b})},set:function(b,d){var c=this.get(b);if(c){c.data=d}else{this.list.push({key:this.stringifyKey(b),data:d})}},getData:function(b){var c=this.get(b);return c?c.data:null},get:function(c){c=this.stringifyKey(c);var b=this.list.filter(function(d){return(d.key==c)});return(b.length>0?b[0]:null)},has:function(b){return !!this.get(b)}},requestConsent:function(f,b,d,e){b=b||{};b.id=f;var c=this.cache.stringifyKey(b);if(!this.popup.isInit){this.popup.caller=this;if(!this.popup.init()){return}BX.addCustomEvent(this.popup,"accept",d.bind(this));BX.addCustomEvent(this.popup,"reject",e.bind(this))}if(this.current&&this.current.config.text){this.cache.set(c,this.current.config.text)}if(this.cache.has(c)){this.setTextToPopup(this.cache.getData(c))}else{this.popup.setTitle(BX.message(this.msg.loading));this.popup.show(false);this.sendActionRequest("getText",b,function(g){this.cache.set(c,g.text||"");this.setTextToPopup(this.cache.getData(c))},function(){this.popup.hide();alert(BX.message(this.msg.errTextLoad))})}},setTextToPopup:function(e){var c="";var d=e.indexOf("\n");var b=e.indexOf(".");d=d<b?d:b;if(d>=0&&d<=100){c=e.substr(0,d).trim();c=c.split(".").map(Function.prototype.call,String.prototype.trim).filter(String)[0]}this.popup.setTitle(c?c:BX.message(this.msg.title));this.popup.setContent(e);this.popup.show(true)},saveConsent:function(c,f){this.setCurrent(c);var d={id:c.config.id,sec:c.config.sec,url:window.location.href};if(c.config.originId){var e=c.config.originId;if(c.formNode&&e.indexOf("%")>=0){var b=c.formNode.querySelectorAll('input[type="text"], input[type="hidden"]');b=BX.convert.nodeListToArray(b);b.forEach(function(g){if(!g.name){return}e=e.replace("%"+g.name+"%",g.value?g.value:"")})}d.originId=e}if(c.config.originatorId){d.originatorId=c.config.originatorId}BX.onCustomEvent(c,this.events.save,[d]);BX.onCustomEvent(this,this.events.save,[c,d]);if(this.isConsentSaved||!c.config.autoSave){if(f){f.apply(this,[])}}else{this.sendActionRequest("saveConsent",d,f,f)}},sendActionRequest:function(e,c,d,b){d=d||null;b=b||null;c.action=e;c.sessid=BX.bitrix_sessid();c.action=e;BX.ajax({url:this.actionRequestUrl,method:"POST",data:c,timeout:10,dataType:"json",processData:true,onsuccess:BX.proxy(function(f){f=f||{};if(f.error){b.apply(this,[f])}else{if(d){d.apply(this,[f])}}},this),onfailure:BX.proxy(function(){var f={error:true,text:""};if(b){b.apply(this,[f])}},this)})}};BX.ready(function(){BX.UserConsent.loadFromForms()})})();